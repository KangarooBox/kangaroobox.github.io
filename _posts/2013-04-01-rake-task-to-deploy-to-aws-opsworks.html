---
layout: post
title: Rake task to deploy to AWS OpsWorks
date: '2013-04-01T19:39:00.000-04:00'
author: Richard Hurt
comments: true
tags: Ruby Rake OpsWorks AWS
modified_time: '2013-04-01T19:39:50.471-04:00'
blogger_id: tag:blogger.com,1999:blog-5693054744995313095.post-4823031858424242063
blogger_orig_url: http://kangaroobox.blogspot.com/2013/04/rake-task-to-deploy-to-aws-opsworks.html
permalink: 2013/04/rake-task-to-deploy-to-aws-opsworks.html
permalink: 2013/04/rake-task-to-deploy-to-aws-opsworks.html
---

<h2>Introduction</h2>I've spent the day building a deploy Rake task for my AWS OpsWorks environment and I thought I would share it with you.<br /><br />My project is a pretty simple Sinatra application that is being hosted in Amzon's cloud environment (AWS) with the help of the OpsWorks tools. &nbsp;One of the things I wanted to do is to make it easy to deploy the application from the command line. &nbsp;I guess I've gotten lazy with Heroku's "deploy from a Git push" and I wanted something similar in my new environment. <br /><br />After working out a couple of kinks, it&nbsp;wasn't&nbsp;too difficult really. &nbsp;Here's how to set it up in your environment. &nbsp;Basically, you just need to create a couple of files and fill in some default values from your OpsWorks environment.<br /><br />The <code>opsworks.yml</code> file defines all the layer/app ID's in all the regions you want to deploy to.<br /><pre class="brush:ruby"># config/opsworks.yml<br />us-east-1:<br />  layer_id: "your-layer-id"<br />  app_id: "your-app-id"<br /><br />us-west-1:<br />  layer_id: "your-layer-id"<br />  app_id: "your-app-id"<br /></pre><br />The <code>Rakefile</code> file defines the rake tasks needed to deploy your software.  Just make sure that you have the 'aws-sdk' Gem installed and a valid AWS credentials.  I'm using a <code>config/aws.yml</code> file but you can do whatever you like.<br /><pre class="brush:ruby"># Rakefile<br />require 'rubygems'<br />require 'bundler'<br />Bundler.require if defined?(Bundler)<br /><br /># Authenticate to AWS<br />AWS.config(YAML.load_file('config/aws.yml')['production'])<br />client = AWS::OpsWorks.new.client<br /><br />desc "Deploy the app to the LIVE environment"<br />task :deploy do<br />  regions = YAML.load_file('config/opsworks.yml')<br /><br />  deploy_options = {}<br />  deploy_options[:command] = {name:'deploy'}<br /><br />  # Loop through each region<br />  regions.each do |region, options|<br />    deploy_options[:instance_ids] = []<br />    deploy_options[:app_id]   = options['app_id']<br />    deploy_options[:comment]  = "rake deploy from '#{Socket.gethostname}'"<br />    instances = client.describe_instances({layer_id: options['layer_id']})<br /><br />    next if instances.nil? || instances.empty?<br /><br />    # Capture the details for each 'online' instance<br />    instances[:instances].each do |instance|<br />      if 'online' == instance[:status]<br />        deploy_options[:instance_ids] &lt;&lt; instance[:instance_id]<br />        deploy_options[:stack_id] = instance[:stack_id]<br />      end<br />    end<br /><br />    puts "Deploying to #{deploy_options[:instance_ids].count} instances in the #{region.upcase} region..."<br />    client.create_deployment deploy_options<br />  end<br />end<br /></pre><br /><h2>Usage</h2><br />Just run <code>rake deploy</code> to deploy your code to any "online" instances that matches the regions/apps/layers in your config file.
