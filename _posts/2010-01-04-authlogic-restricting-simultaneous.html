---
layout: post
title: 'Authlogic: Restricting simultaneous sessions'
date: '2010-01-04T14:11:00.005-05:00'
author: Richard Hurt
tags:
- ruby on rails
- programming
- authlogic
modified_time: '2010-01-26T13:45:51.357-05:00'
blogger_id: tag:blogger.com,1999:blog-5693054744995313095.post-5707298607053930092
blogger_orig_url: http://kangaroobox.blogspot.com/2010/01/authlogic-restricting-simultaneous.html
---

I'm building a Rails based application for a client, which they are in-turn licensing to their customers on a per-seat basis.  This means that they don't want multiple people using the same login at the same time; if you have 5 people in your shop, you have to purchase 5 licenses.  Makes sense to me.<br /><br />Anyway, we're using the splendid <a href="http://github.com/binarylogic/authlogic">Authlogic</a> plug-in for all the authentication duties and while it does many things very well it doesn't have a built-in way to restrict simultaneous logins.  I asked around and got a couple of tips on what might work and how I might proceed.  It was a simple process but after several others had the same problem I thought I would formalize the "solution" in a blog post in hopes that it might help someone else in the future.<br /><br /><ul><li>Step One - Add a place to store a session key<br /><pre name="code" class="brush:ruby"># add_session_key_to_users.rb<br />class AddSessionKeyToUsers < ActiveRecord::Migration<br />def self.up<br />add_column :users, :session_key, :string<br />end<br /><br />def self.down<br />remove_column :users, :session_key<br />end<br />end<br /></pre> This gives us a place to store a "session_key" value that changes every time a user logs in. </li> <li>Step Two - Insert the "session_key" on login<br /><pre name="code" class="brush:ruby"># user_sessions_controller.rb<br />def create<br />...<br />if @user_session.save<br /># Save the session ID to detect simultaneous login attempts<br />@user_session.record.session_key = session[:session_id]<br />@user_session.record.save!<br />...<br />end<br />end<br /></pre><br />What this does is forces the session_id to be saved to the User model each time a user logs into the site.  We'll check this value later to make sure the session hasn't changed.  I'm using the session_id here as a "unique" value but it could be anything you want; timestamp, IP address, etc...<br /></li> <li>Step Three - Make sure the user is unique<br /><pre name="code" class="brush:ruby"># application_controller.rb<br />def current_user<br />...<br /># Prevent simultaneous logins<br />if @current_user && @current_user.session_key != session[:session_id]<br />flash[:notice] = 'Access denied. Simultaneous logins detected.'<br />current_user_session.destroy <br />end<br />end<br /></pre><br />Here is where the rubber meets the road, so to speak.  In Authlogic, the current_user method is accessed on every page request so it is the perfect place to check for duplicate user sessions.  We simple verify that the session_id in the users cookie is the same one in the database.  If they are different we destroy the session and update the flash message.<br /></li> </ul><br /><br />This is a pretty simple little hack but it seems to work OK.  One "problem" that I have noticed is that while the session is immediately destroyed the current request continues unabated.  This means that the two users could possibly perform two actions at the same time, but it shouldn't be a problem.  Another side effect of this technique is that the last user to log in always gets the session.  This might be a problem for you but it wasn't for my project.