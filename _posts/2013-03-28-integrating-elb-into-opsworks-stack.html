---
layout: post
title: Integrating ELB into an OpsWorks stack
date: '2013-03-28T10:07:00.000-04:00'
author: Richard Hurt
tags: AWS ELB Chef OpsWorks
comments: true
modified_time: '2013-05-14T23:02:18.474-04:00'
blogger_id: tag:blogger.com,1999:blog-5693054744995313095.post-3051472231977812607
blogger_orig_url: http://kangaroobox.blogspot.com/2013/03/integrating-elb-into-opsworks-stack.html
permalink: 2013/03/integrating-elb-into-opsworks-stack.html
permalink: 2013/03/integrating-elb-into-opsworks-stack.html
---

<h3>UPDATE: Amazon has now built <a href="http://aws.amazon.com/about-aws/whats-new/2013/05/14/aws-opsworks-supports-elb/">ELB capability</a> into OpsWorks, so you no longer need to use this workaround.</h3><br />As you might have guessed by my recent posts I'm experimenting with the <a href="http://aws.amazon.com/opsworks/">AWS OpsWorks</a> platform. &nbsp;I have been generally very pleased with everything except its lack of integration with existing AWS tools, specifically <a href="http://aws.amazon.com/elasticloadbalancing/">Elastic Load Balancers</a>. &nbsp;OpsWorks does include an <a href="http://haproxy.1wt.eu/">HAProxy</a> stack that you can use to load balance your system, but it lacks several features that ELB has and I find valuable. <br /><div><br /></div><div>To start, ELB is just easier to setup and manage. &nbsp;Basically, you don't have to do anything at all with it, just create an ELB instance through the GUI and attach your instances to it. &nbsp;It also multiple provides SSL termination points and automatically scales based on load. &nbsp;To top it off, it's cheaper than running your own HAProxy stack through OpsWorks. &nbsp;:)</div><div><br /></div><div>The problem is that OpsWorks doesn't provide a way to integrate with ELB, <a href="http://aws.typepad.com/aws/2013/02/aws-opsworks-one-week-report.html">at least not yet</a>. &nbsp;So you have to wire it up yourself. &nbsp;This is not too big of a deal if you're already familiar with the AWS command line tools and <a href="http://www.opscode.com/chef/">Chef</a>, which is what Amazon uses to manage their instances. &nbsp;Unfortunately, I'm not super familiar with these things so I had to blindly work my way through the setup. &nbsp;Here's how I did it.<br /><br />1) Create an ELB in the normal way and give it some name "my-project-lb"<br /><br />2) Create a custom Chef cookbook and check it into Github or store it in an S3 bucket or something. &nbsp;It should look something like this:<br /><pre class="brush:shell">$ mkdir -p cookbooks/aws/recipes<br />$ touch cookbooks/aws/recipes/default.rb<br />$ touch cookbooks/aws/recipes/register.rb<br />$ touch cookbooks/aws/recipes/deregister.rb<br /></pre><br />3) Edit the recipes in your cookbook to look something like this, replacing code as necessary:<br /><pre class="brush:shell">## cookbooks/aws/recipes/default.rb<br />package "aws-cli" do<br />&nbsp; action :install<br />end</pre><br /><pre class="brush:shell">## cookbooks/aws/recipes/register.rb<br />include_recipe "aws"<br /><br />execute "register" do<br />  command "aws --region #{node[:opsworks][:instance][:region]} elb register-instances-with-load-balancer --load-balancer-name my-project-lb --instances '{\"instance_id\":\"#{node[:opsworks][:instance][:aws_instance_id]}\"}'"<br />  user "deploy"<br />end</pre><br /><pre class="brush:shell">## cookbooks/aws/recipes/deregister.rb<br />include_recipe "aws"<br /><br />execute "deregister" do<br />  command "aws --region #{node[:opsworks][:instance][:region]} elb deregister-instances-from-load-balancer --load-balancer-name my-project-lb --instances '{\"instance_id\":\"#{node[:opsworks][:instance][:aws_instance_id]}\"}'"<br />  user "deploy"<br />end</pre></div><br /><div>3) Add your new cookbook to the OpsWorks custom Chef cookbook in your Application stack.<br /><br />4) Finally, add your new&nbsp;recipes to the proper <a href="http://aws.amazon.com/opsworks/faqs/#lifecycle">stack lifecycle events</a>. &nbsp;I chose Configure to run the "aws::register" recipe and&nbsp;&nbsp;Shutdown to run the "aws::deregister" recipe.<br /><br />Now just sit back and enjoy your new, cheaper, easier-to-use auto-balancing OpsWorks system. &nbsp;:)</div>
