---
layout: post
title: Backing up your database with logrotate
date: '2009-07-23T09:28:00.009-04:00'
author: Richard Hurt
tags:
- logrotate
- boxbackup
- backup
- postgresql
modified_time: '2010-01-26T13:47:14.122-05:00'
blogger_id: tag:blogger.com,1999:blog-5693054744995313095.post-7022299109345350256
blogger_orig_url: http://kangaroobox.blogspot.com/2009/07/backing-up-your-database-with-logrotate.html
---

I use <a href="http://www.boxbackup.org/">BoxBackup</a> in lazy mode to back up my systems.  This works well for things like normal files and directories but not so well for databases.  I wanted to periodically dump my database to a file and then have BoxBackup come along and do its thing.  The only problem was how to name each backup file and how to clean up after so many backups had been done.  Since it runs in lazy mode I can't know ahead of time exactly when the backup will happen and which files it will backup.<br /><br />I looked at generating files with timestamps and then doing some calculations about cleaning up old files but that just seemed messy and I was sure that someone must have run into this type of situation before.  Then I thought about log files and how they are backed up.  It turns out the the standard Linux <code>logrotate</code> command knows how to rename files and get rid of old ones automagically.  It even has script functionality that allows you to run commands before and after the rotate happens.  Sounds perfect.  Here's what I did.<br /><br />First I created a directory in my web apps directory to hold all the database information and backup files.  I'm using PostgreSQL, but you could do the same thing for MySQL or even Oracle.  Just change the names of the directories and commands to something more suitable for your environment.<br /><br /><pre name="code" class="brush:shell">$ mkdir /var/www/postgres<br /></pre><br /><br />Next we have to create a status file for <code>logrotate</code> to use.  Since we will be running this as a non-root user we don't want to pollute the system status file with our non-log database backup stuff.<br /><br /><pre name="code" class="brush:shell">$ touch /var/www/postgres/logrotate.status<br /></pre><br /><br />We also want to create a "fake" dump file so that <code>logrotate</code> will have something to start working with.  If this file doesn't exist <code>logrotate</code> will refuse to rotate it.  In this case we are backing up a Postgres database called "mydatabase".<br /><br /><pre name="code" class="brush:shell">$ touch /var/www/postgres/mydatabase.dump<br /></pre><br /><br />Now we get to the heart of the matter; the logroate script itself.  This tells <code>logrotate</code> to keep 10 copies of our dump but don't compress it and dont copy it.  It will also complain if there is no original file to backup and it will create a blank "dump" for next time.<br /><br /><pre name="code" class="brush:shell"># /var/www/postgres/logrotate.pg_dump<br /># Dump PostgreSQL databases and prepare them for backup<br />/var/www/postgres/mydatabase.dump {<br />rotate 10<br />nomissingok<br />create<br />nocompress<br />nocopy<br />prerotate<br />test -x /usr/bin/pg_dump || exit 0<br />/usr/bin/pg_dump mydatabase -F c > /var/www/postgres/mydatabase.dump<br />endscript<br />}<br /></pre><br /><br />One final step and we're done.  The <code>pg_dump</code> command connects to the database as the user who runs it and the postgres user has access to all the databases by default (on Debian anyway).  So running the <code>logrotate</code> command as the postgres user allows us to backup any database on the system without a password.  And in order to allow the postgres user access to our new setup we have to change the owner on the files in /var/www/postgres.<br /><br /><pre name="code" class="brush:shell">$ chown -R postgres:postgres /var/www/postgres<br /></pre><br /><br />Now, whenever you want to generate a new database dump just run the following command.  You can put this is a crontab or just run it by hand.  Remember to use the <code>-f</code> flag to force the backup to happen. <br /><br /><pre name="code" class="brush:shell">$/usr/sbin/logrotate -f /var/www/postgres/logrotate.pg_dump -s /var/www/postgres/logrotate.status<br /></pre>