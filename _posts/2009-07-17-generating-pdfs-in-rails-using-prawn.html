---
layout: post
title: Generating PDFs in Rails using Prawn
date: '2009-07-17T23:00:00.000-04:00'
author: Richard Hurt
comments: true
tags:
- prawn
- ruby on rails
- pdf
modified_time: '2009-07-17T23:01:15.913-04:00'
blogger_id: tag:blogger.com,1999:blog-5693054744995313095.post-2452602740293219848
blogger_orig_url: http://kangaroobox.blogspot.com/2009/07/generating-pdfs-in-rails-using-prawn.html
permalink: 2009/07/generating-pdfs-in-rails-using-prawn.html
---

In my current Rails projects (<a href="http://github.com/rnhurt/gradesheet">Gradesheet</a> & <a href="http://mynastuff.com">MynaStuff</a>) I have the need to create reports as PDFs.  Prawn is a relatively new library that does just what I need in pure Ruby.  There are a couple of really good tutorials on how to integrate Prawn into your Rails project on the web but I wanted to do something a little different.  There's even a plugin (<a href="http://www.cracklabs.com/prawnto">PrawnTo</a>) that makes Prawn look like a native Rails construct and allows you build PDFs without leaving your views.  Neat!<br /><br />However, this is not really how I wanted to implement reporting in my applications.  So I created a directory in lib and filled it with self-contained reports.  In my view, this makes reports easier to build and maintain.  Let's get started.  First, you need a Rails project.<br /><br /><pre name="code" class="brush:ruby"><br />strutter$ rails HelloPrawn<br />      create  <br />      create  app/controllers<br />       ...<br />      create  log/server.log<br />      create  log/production.log<br />      create  log/development.log<br />      create  log/test.log<br /></pre><br />Now, we need to get the Prawn & Prawn-layout plugins.  Since they are pretty new and constantly changing I like to get the latest version straight from GitHub.  Just clone them in the usual way.  Note that you have to get a couple of subcollections when you get Prawn this way.<br /><pre name="code" class="brush:ruby"><br />$cd vendor/plugins<br />$git clone git://github.com/sandal/prawn.git<br />Initialized empty Git repository in /Rails/HelloPrawn/vendor/plugins/prawn/.git/<br />remote: Counting objects: 6716, done.<br />remote: Compressing objects: 100% (2762/2762), done.<br />Receiving objects:  21% (1459/6716), 6.31 MiB | 220 KiB/s     <br />...<br />$git clone git://github.com/sandal/prawn-layout.git<br />Initialized empty Git repository in /Rails/HelloPrawn/vendor/plugins/prawn-layout/.git/<br />remote: Counting objects: 271, done.<br />remote: Compressing objects: 100% (232/232), done.<br />remote: Total 271 (delta 111), reused 0 (delta 0)<br />...<br /></pre><br />Since we are running Prawn from Git we have to do a couple of extra things.<br /><pre name="code" class="brush:ruby"><br />$cd vendor/plugins/prawn<br />$git submodule init<br />Submodule 'vendor/pdf-inspector' (git://github.com/sandal/pdf-inspector.git) registered for path 'vendor/pdf-inspector'<br />Submodule 'vendor/ttfunk' (git://github.com/sandal/ttfunk.git) registered for path 'vendor/ttfunk'<br />$git submodule update<br />Initialized empty Git repository in /Users/richardhurt/Rails/HelloPrawn/vendor/plugins/prawn/vendor/pdf-inspector/.git/<br />remote: Counting objects: 16, done.<br />remote: Compressing objects: 100% (14/14), done.<br />...<br /></pre><br />Now we have to tell Rails to load Prawn-layout as well as Prawn.  I do this with a simple initializer.<br /><pre name="code" class="brush:ruby"><br /># config/initializers/prawn.rb<br />require "prawn/core"<br />require "prawn/layout"<br /></pre><br />Next we'll create a report.  First build a new directory to hold all your reports.<br /><pre name="code" class="brush:ruby"><br />mkdir lib/reports<br /></pre><br />Then add this new path to your Rails load_path.  Look for the following section in you config/environment.rb file and make it look similar to this.<br /><pre name="code" class="brush:ruby"><br /># Add additional load paths for your own custom dirs config.load_paths += %W({RAILS_ROOT}/extras )<br />config.load_paths += %W( #{RAILS_ROOT}/lib/reports )<br /></pre><br />and add a new PDF mime type.<br /><pre name="code" class="brush:ruby"><br />#config/initializers/mime_types.rb <br />Mime::Type.register_alias "application/pdf", :pdf<br /></pre><br />Now that most of the setup is out of the way we're ready to get to work.  Let's create a simple report and then show the controller that goes along with it.  This report doesn't do much but it shows the basics.<br /><br /><pre name="code" class="brush:ruby"><br /># lib/reports/hello_prawn.rb<br />class HelloPrawn<br /><br />  # Build the parameter screen for this report.<br />    def self.get_params()<br />      # This report has no parameters<br />    end<br /><br />  # Build the report in PDF form and sent it to the users browser<br />  def self.draw(params)<br />    # Create a new document<br />    pdf = Prawn::Document.new(:page => "LETTER")<br /><br />      # Make it so we don't have to use pdf. everywhere.  :)<br />      pdf.instance_eval do<br />        # Print something<br />        text "Hello Prawn", :align => :center, :size => 20<br /><br />        # Render the page and send it back to the controller<br />        render<br />      end<br /><br />    end<br />  end<br /></pre><br />Finally we'll build a controller to either build the parameter screen or render the PDF itself.<br /><pre name="code" class="brush:ruby"><br />class ReportsController < ApplicationController<br />  <br />  def show<br />    # Since we are building the report object on the fly we need to make sure<br />    # that it is a valid report before we try to build/show it.<br />    begin<br />      # Try to make the report into an 'object'<br />      @report = params[:id].classify.constantize<br />    rescue NameError<br />      # This is not a valid report or some other error happened<br />      flash[:error] = "Unknown Report '#{params[:id]}'"<br />      redirect_to :action => :index<br />    else<br /><br />      respond_to do |format|<br />        format.html  do<br />          # display the parameters screen<br />        end<br /><br />        format.pdf do<br />          # Send the PDF back to the browser for viewing<br />          send_data @report.draw(params),<br />            :filename      => params[:id].titleize + '.pdf',<br />            :type              => 'application/pdf',<br />            :disposition  => 'inline'<br />          end<br />        end<br />      end<br />    end<br />end<br /></pre><br />Lets test it out.  Start up your Rails server and go to <a href="http://localhost:3000/reports/hello_prawn.pdf">http://localhost:3000/reports/hello_prawn.pdf</a> and you should get an inline PDF report in return.  The cool thing about this is that each report can generate its own parameters screen on demand.  See that self.get_params() function up in the report?  That's where you can put your ERB stuff and have it render when you hit <a href="http://localhost:3000/reports/hello_prawn">http://localhost:3000/reports/hello_prawn</a>.  Neato!<br /><pre name="code" class="brush:ruby"><br />  def self.get_params()<br />    # Get the homeroom information<br />    homerooms = Student.find_homerooms()<br />                <br />    # Build the parameter screen<br />    params = <<-EOS<br /><br />        <form action="/reports/student_roster.pdf" method="get"><br />          <fieldset><br />            <legend>Student Roster</legend><br />            <br />                <label>Homeroom</label><br />                        <select name='homeroom'><br />                                <option value=''>ALL</option><br />EOS<br /><br />    # Add the homerooms<br />    homerooms.each do |homeroom|<br />      params += "<option value='#{homeroom}'>#{homeroom}</option>"<br />    end<br /><br />    params += <<-EOS<br />                        </select><br />                        <br />                <div class="spacer"><br />                        <input class="btn positive" type="submit" value="Run Report" /><br />                </div><br />                </fieldset><br />        </form><br />EOS<br /></pre>
